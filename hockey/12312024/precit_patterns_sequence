# Function to predict next number in sequence
function Predict-NextNumber {
    param (
        [array]$Sequence
    )

    # Check for arithmetic sequence
    $diff = $Sequence[1] - $Sequence[0]
    $isArithmetic = $true
    for ($i = 2; $i -lt $Sequence.Count; $i++) {
        if ($Sequence[$i] - $Sequence[$i-1] -ne $diff) {
            $isArithmetic = $false
            break
        }
    }
    if ($isArithmetic) {
        return $Sequence[-1] + $diff
    }

    # Check for geometric sequence
    $ratio = $Sequence[1] / $Sequence[0]
    $isGeometric = $true
    for ($i = 2; $i -lt $Sequence.Count; $i++) {
        if ($Sequence[$i] / $Sequence[$i-1] -ne $ratio) {
            $isGeometric = $false
            break
        }
    }
    if ($isGeometric) {
        return $Sequence[-1] * $ratio
    }

    # If no pattern is found, return null
    return $null
}

# Example usage:
$sequence = @(1, 2, 3, 4, 5)
$nextNumber = Predict-NextNumber -Sequence $sequence
Write-Host "Next number in sequence: $nextNumber"

$sequence = @(2, 4, 8, 16, 32)
$nextNumber = Predict-NextNumber -Sequence $sequence
Write-Host "Next number in sequence: $nextNumber"

function Get-NextNumberInSequence {
    param (
        [Parameter(Mandatory = $true)]
        [double[]]$Sequence
    )

    # Need at least 3 numbers to detect a pattern
    if ($Sequence.Count -lt 3) {
        Write-Error "Please provide at least 3 numbers in the sequence"
        return $null
    }

    # Check for arithmetic sequence (constant difference)
    $differences = @()
    for ($i = 1; $i -lt $Sequence.Count; $i++) {
        $differences += $Sequence[$i] - $Sequence[$i - 1]
    }

    # Check if all differences are equal (arithmetic sequence)
    $isArithmetic = $true
    for ($i = 1; $i -lt $differences.Count; $i++) {
        if ([Math]::Abs($differences[$i] - $differences[$i - 1]) -gt 0.0001) {
            $isArithmetic = $false
            break
        }
    }

    if ($isArithmetic) {
        $nextNumber = $Sequence[-1] + $differences[0]
        return @{
            NextNumber = $nextNumber
            Pattern = "Arithmetic sequence with common difference of $($differences[0])"
        }
    }

    # Check for geometric sequence (constant ratio)
    $ratios = @()
    for ($i = 1; $i -lt $Sequence.Count; $i++) {
        if ($Sequence[$i - 1] -ne 0) {
            $ratios += $Sequence[$i] / $Sequence[$i - 1]
        }
    }

    # Check if all ratios are equal (geometric sequence)
    $isGeometric = $true
    for ($i = 1; $i -lt $ratios.Count; $i++) {
        if ([Math]::Abs($ratios[$i] - $ratios[$i - 1]) -gt 0.0001) {
            $isGeometric = $false
            break
        }
    }

    if ($isGeometric) {
        $nextNumber = $Sequence[-1] * $ratios[0]
        return @{
            NextNumber = $nextNumber
            Pattern = "Geometric sequence with common ratio of $($ratios[0])"
        }
    }

    # Check for Fibonacci-like sequence (each number is sum of previous two)
    $isFibonacci = $true
    for ($i = 2; $i -lt $Sequence.Count; $i++) {
        if ([Math]::Abs($Sequence[$i] - ($Sequence[$i - 1] + $Sequence[$i - 2])) -gt 0.0001) {
            $isFibonacci = $false
            break
        }
    }

    if ($isFibonacci) {
        $nextNumber = $Sequence[-1] + $Sequence[-2]
        return @{
            NextNumber = $nextNumber
            Pattern = "Fibonacci-like sequence (each number is sum of previous two)"
        }
    }

    # Check for square numbers
    $isSquare = $true
    for ($i = 0; $i -lt $Sequence.Count; $i++) {
        $sqrt = [Math]::Sqrt($Sequence[$i])
        if ([Math]::Abs($sqrt - [Math]::Round($sqrt)) -gt 0.0001) {
            $isSquare = $false
            break
        }
    }

    if ($isSquare) {
        $lastRoot = [Math]::Sqrt($Sequence[-1])
        $nextNumber = [Math]::Pow($lastRoot + 1, 2)
        return @{
            NextNumber = $nextNumber
            Pattern = "Square numbers sequence"
        }
    }

    # If no pattern is detected
    return @{
        NextNumber = $null
        Pattern = "No common pattern detected"
    }
}

# Function to demonstrate usage with example sequences
function Test-SequencePredictor {
    $testSequences = @(
        @(2, 4, 6, 8, 10),              # Arithmetic
        @(2, 4, 8, 16, 32),             # Geometric
        @(1, 1, 2, 3, 5, 8),            # Fibonacci
        @(1, 4, 9, 16, 25),             # Square numbers
        @(1, 3, 7, 15, 31)              # Unknown pattern
    )

    foreach ($sequence in $testSequences) {
        Write-Host "`nAnalyzing sequence: $sequence"
        $result = Get-NextNumberInSequence -Sequence $sequence
        Write-Host "Pattern detected: $($result.Pattern)"
        if ($result.NextNumber -ne $null) {
            Write-Host "Predicted next number: $($result.NextNumber)"
        }
    }
}

# Example usage:
# Test-SequencePredictor

# To predict next number in a custom sequence:
# $mySequence = @(1, 3, 5, 7)
# Get-NextNumberInSequence -Sequence $mySequence



function Get-QLSequence {
    param (
        [Parameter(Mandatory = $true)]
        [int]$Length,
        
        [Parameter(Mandatory = $false)]
        [int]$StartNumber = 1,

        [Parameter(Mandatory = $false)]
        [double]$Alpha = (1 + [Math]::Sqrt(5)) / 2  # Golden ratio as default
    )

    # Initialize array to store sequence
    $sequence = New-Object double[] $Length
    $sequence[0] = $StartNumber
    
    # Generate QLS sequence
    for ($i = 1; $i -lt $Length; $i++) {
        $sequence[$i] = [Math]::Floor($Alpha * ($i + 1))
    }

    # Calculate differences
    $differences = @()
    for ($i = 1; $i -lt $Length; $i++) {
        $differences += $sequence[$i] - $sequence[$i - 1]
    }

    # Calculate second-order differences
    $secondOrderDifferences = @()
    for ($i = 1; $i -lt $differences.Count; $i++) {
        $secondOrderDifferences += $differences[$i] - $differences[$i - 1]
    }

    return [PSCustomObject]@{
        Sequence = $sequence
        Differences = $differences
        SecondOrderDifferences = $secondOrderDifferences
        Alpha = $Alpha
        Info = "QLS using multiplier $Alpha"
    }
}

function Get-SequenceAnalytics {
    param (
        [Parameter(Mandatory = $true)]
        [double[]]$Sequence,
        [Parameter(Mandatory = $true)]
        [double[]]$Differences
    )

    # Growth rate analysis
    $growthRates = @()
    for ($i = 1; $i -lt $Sequence.Count; $i++) {
        if ($Sequence[$i-1] -ne 0) {
            $growthRates += $Sequence[$i] / $Sequence[$i-1]
        }
    }

    # Statistical measures
    $stats = @{
        Mean = ($Sequence | Measure-Object -Average).Average
        Median = $Sequence | Sort-Object | Select-Object -Index ([Math]::Floor($Sequence.Count/2))
        StandardDeviation = [Math]::Sqrt(($Sequence | ForEach-Object { [Math]::Pow($_ - ($Sequence | Measure-Object -Average).Average, 2) } | Measure-Object -Average).Average)
        DifferenceMean = ($Differences | Measure-Object -Average).Average
        DifferenceVariance = ($Differences | ForEach-Object { [Math]::Pow($_ - ($Differences | Measure-Object -Average).Average, 2) } | Measure-Object -Average).Average
    }

    return [PSCustomObject]@{
        Statistics = $stats
        GrowthRates = $growthRates
        AverageGrowthRate = ($growthRates | Measure-Object -Average).Average
    }
}

function Show-QLSProperties {
    param (
        [Parameter(Mandatory = $true)]
        [int]$Length,
        
        [Parameter(Mandatory = $false)]
        [int]$StartNumber = 1,

        [Parameter(Mandatory = $false)]
        [switch]$DetailedAnalysis
    )

    $result = Get-QLSequence -Length $Length -StartNumber $StartNumber
    $analytics = Get-SequenceAnalytics -Sequence $result.Sequence -Differences $result.Differences
    
    Write-Host "Quasilinear Sequence Analysis" -ForegroundColor Cyan
    Write-Host "============================" -ForegroundColor Cyan
    
    Write-Host "`nSequence (First $Length terms):" -ForegroundColor Yellow
    Write-Host ($result.Sequence -join ", ")
    
    Write-Host "`nBasic Properties:" -ForegroundColor Yellow
    Write-Host "Length: $Length"
    Write-Host "Starting Number: $StartNumber"
    Write-Host "Multiplier (Î±): $($result.Alpha)"
    
    Write-Host "`nFirst-Order Differences:" -ForegroundColor Yellow
    Write-Host ($result.Differences -join ", ")
    
    Write-Host "`nSecond-Order Differences:" -ForegroundColor Yellow
    Write-Host ($result.SecondOrderDifferences -join ", ")
    
    Write-Host "`nStatistical Analysis:" -ForegroundColor Yellow
    Write-Host "Mean: $($analytics.Statistics.Mean)"
    Write-Host "Median: $($analytics.Statistics.Median)"
    Write-Host "Standard Deviation: $($analytics.Statistics.StandardDeviation)"
    Write-Host "Average Difference: $($analytics.Statistics.DifferenceMean)"
    Write-Host "Difference Variance: $($analytics.Statistics.DifferenceVariance)"
    
    # Verify QLS properties
    $maxDiff = ($result.Differences | Measure-Object -Maximum).Maximum
    $minDiff = ($result.Differences | Measure-Object -Minimum).Minimum
    $diffRange = $maxDiff - $minDiff
    
    Write-Host "`nQLS Properties:" -ForegroundColor Yellow
    Write-Host "Difference Range: [$minDiff, $maxDiff]"
    Write-Host "Range Size: $diffRange"
    Write-Host "Bounded Difference Property: $(if ($diffRange -le 2) {'Satisfied'} else {'Not Satisfied'})"
    
    if ($DetailedAnalysis) {
        Write-Host "`nDetailed Growth Analysis:" -ForegroundColor Yellow
        Write-Host "Growth Rates: $($analytics.GrowthRates -join ", ")"
        Write-Host "Average Growth Rate: $($analytics.AverageGrowthRate)"
        
        # Analyze periodicity
        $periodicityCheck = @{}
        $result.Differences | ForEach-Object { 
            if ($periodicityCheck.ContainsKey($_)) {
                $periodicityCheck[$_]++
            } else {
                $periodicityCheck[$_] = 1
            }
        }
        
        Write-Host "`nDifference Distribution:" -ForegroundColor Yellow
        $periodicityCheck.GetEnumerator() | Sort-Object Key | ForEach-Object {
            Write-Host "Value $($_.Key): $($_.Value) occurrences"
        }
    }
}

# Example usage:
# Basic analysis:
# Show-QLSProperties -Length 15

# Detailed analysis:
# Show-QLSProperties -Length 15 -DetailedAnalysis

# Custom start number:
# Show-QLSProperties -Length 15 -StartNumber 5 -DetailedAnalysis
